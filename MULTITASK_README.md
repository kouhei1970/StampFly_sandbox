# ESP32-S3 StampFly マルチタスクシステム

## 概要

ESP32-S3のドローンファームウェアをFreeRTOSを用いてマルチタスク化しました。制御ループを400Hzで確実に実行し、センサー読み取りとその他の処理を適切に分離することで、リアルタイム性能を向上させています。

## システム構成

### タスク構成

1. **制御タイマータスク** (最高優先度)
   - 周期: 2.5ms (400Hz)
   - 役割: 制御タスクに正確な400Hz周期で通知を送信

2. **制御タスク** (高優先度)
   - 周期: 2.5ms (400Hz) - タイマータスクからの通知待ち
   - 役割: 姿勢制御、レート制御、モーター出力制御

3. **高速センサータスク** (高優先度)
   - 周期: 2.5ms (400Hz)
   - 役割: IMUデータ読み取り、姿勢推定

4. **低速センサータスク** (中優先度)
   - 周期: 20ms (50Hz)
   - 役割: ToF、磁気センサー、オプティカルフロー、電圧監視

5. **通信タスク** (低優先度)
   - 周期: 100ms (10Hz)
   - 役割: テレメトリ、LED制御、CLI処理

### データ共有

- **ミューテックス保護**: 全ての共有データはミューテックスで保護
- **タイムスタンプ**: 全データにマイクロ秒精度のタイムスタンプ付与
- **データ有効性**: データの有効性フラグで古いデータの使用を防止

## ファイル構成

```
src/
├── multitask_data.hpp          # データ構造定義
├── multitask_data.cpp          # データ管理実装
├── multitask_functions.hpp     # タスク関数定義
├── multitask_functions.cpp     # タスク実装
├── multitask_debug.hpp         # デバッグ機能定義
├── multitask_debug.cpp         # デバッグ機能実装
└── main.cpp                    # メイン関数（マルチタスク初期化）
```

## 主要な改善点

### 1. 確実な400Hz制御周期
- 専用タイマータスクによる正確な周期生成
- タスク通知による低レイテンシ同期
- 制御処理の実行時間監視

### 2. センサーデータの最適化
- IMUデータは400Hzで高速読み取り
- その他センサーは適切な周期で効率的に読み取り
- データの鮮度管理とタイムスタンプ

### 3. リアルタイム性の向上
- 優先度ベースのタスクスケジューリング
- ミューテックスタイムアウトによるデッドロック防止
- 緊急停止機能の実装

### 4. デバッグ・監視機能
- タスク実行時間の測定と統計
- メモリ使用量監視
- スタック使用量チェック
- パフォーマンス統計表示

## 使用方法

### 初期化
```cpp
void setup() {
    // 従来の初期化
    init_copter();
    
    // マルチタスクシステム初期化
    multitask_init();
    multitask_debug_init();
    
    // 全タスク作成
    create_all_tasks();
}
```

### デバッグ機能
```cpp
// 統計情報表示
multitask_debug_print_stats();

// スタック使用量チェック
multitask_debug_check_stack_usage();

// システム情報表示
multitask_debug_print_system_info();

// 統計リセット
multitask_debug_reset_stats();
```

## パフォーマンス特性

### メモリ使用量
- RAM使用量: 約72KB (22%)
- Flash使用量: 約847KB (25.3%)
- 各タスクのスタックサイズ:
  - 制御タスク: 4KB
  - 高速センサー: 3KB
  - 低速センサー: 2KB
  - 通信タスク: 2KB
  - 制御タイマー: 2KB

### 実行時間（典型値）
- 制御タスク: 平均 < 500μs, 最大 < 1000μs
- 高速センサー: 平均 < 300μs, 最大 < 500μs
- 低速センサー: 平均 < 1000μs, 最大 < 2000μs

## 設定パラメータ

### タスク優先度
```cpp
#define CONTROL_TASK_PRIORITY           (configMAX_PRIORITIES - 1)  // 24
#define HIGH_SPEED_SENSOR_PRIORITY      (configMAX_PRIORITIES - 2)  // 23
#define LOW_SPEED_SENSOR_PRIORITY       (configMAX_PRIORITIES - 4)  // 21
#define COMMUNICATION_TASK_PRIORITY     (configMAX_PRIORITIES - 6)  // 19
```

### 周期設定
```cpp
#define CONTROL_TASK_PERIOD_MS          2.5f    // 400Hz
#define HIGH_SPEED_SENSOR_PERIOD_MS     2.5f    // 400Hz
#define LOW_SPEED_SENSOR_PERIOD_MS      20.0f   // 50Hz
#define COMMUNICATION_TASK_PERIOD_MS    100.0f  // 10Hz
```

## トラブルシューティング

### 制御周期が不安定な場合
1. デバッグ統計で実行時間を確認
2. スタック使用量をチェック
3. 他のタスクの処理時間を最適化

### メモリ不足の場合
1. スタックサイズを調整
2. 不要なデバッグ機能を無効化
3. データ構造を最適化

### センサーデータが古い場合
1. タイムスタンプを確認
2. ミューテックスタイムアウトをチェック
3. センサー読み取り周期を調整

## 今後の拡張

1. **適応的制御周期**: 負荷に応じた動的周期調整
2. **センサーフュージョン**: より高度なセンサーデータ統合
3. **ログ機能**: フライトデータの記録と解析
4. **OTA更新**: 無線でのファームウェア更新
5. **省電力モード**: バッテリー寿命の延長

## 注意事項

- 制御タスクの実行時間は2.5ms以内に収める必要があります
- ミューテックスのデッドロックを避けるため、タイムアウトを設定しています
- デバッグ機能は本番環境では無効化することを推奨します
- スタックオーバーフローを防ぐため、定期的にスタック使用量を監視してください

## ライセンス

MIT License - 詳細はLICENSEファイルを参照してください。
